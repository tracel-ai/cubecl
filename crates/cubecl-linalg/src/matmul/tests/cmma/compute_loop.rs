use cubecl_core as cubecl;
use cubecl_core::prelude::*;

use crate::matmul::cmma::{
    base::{make_cmma_matrices, Ids, IdsExpand, SharedMemories, SharedMemoriesExpand},
    compute_loop::compute_loop,
    config::{CmmaConfig, ComptimeCmmaInfo, WriteOutStrategy},
};
use crate::matmul::tests::test_utils::{
    assert_equals, cmma_available, create_empty, range_tensor_f16,
};

#[cube(launch_unchecked)]
fn compute_loop_test<F: Float, FC: Float>(
    lhs_tensor: &Tensor<FC>,
    rhs_tensor: &Tensor<FC>,
    accumulate_array: &mut Array<F>,
    b_mn: Comptime<UInt>,
    b_k: Comptime<UInt>,
    comptime_info: Comptime<ComptimeCmmaInfo>,
) {
    let mut lhs = SharedMemory::<FC>::new(Comptime::get(b_mn * b_k));
    let mut rhs = SharedMemory::<FC>::new(Comptime::get(b_k * b_mn));

    for i in range(0u32, Comptime::get(b_mn * b_k), Comptime::new(false)) {
        lhs[i] = lhs_tensor[i];
    }
    for i in range(0u32, Comptime::get(b_k * b_mn), Comptime::new(false)) {
        rhs[i] = rhs_tensor[i];
    }
    for i in range(0u32, Comptime::get(b_mn * b_mn), Comptime::new(false)) {
        accumulate_array[i] = F::new(0.);
    }

    let shared_memories = SharedMemories { lhs, rhs };
    let mut matrices = make_cmma_matrices::<F, FC>(comptime_info);

    compute_loop(
        shared_memories,
        &mut matrices,
        Ids {
            coop: UNIT_POS_Y,
            lane: UNIT_POS_X,
        },
        comptime_info,
    );

    let num_accumulators = Comptime::map(comptime_info, |c| c.num_accumulators);
    let tile_size = Comptime::map(comptime_info, |c| c.tile_size);
    let slice_offset = Comptime::runtime(tile_size * tile_size);
    let offset = UNIT_POS_Y * slice_offset * Comptime::runtime(num_accumulators);

    let accumulators = matrices.accumulators;
    for n in range(0u32, Comptime::get(num_accumulators), Comptime::new(true)) {
        let slice =
            accumulate_array.slice_mut(offset + n * slice_offset, offset + (n + 1) * slice_offset);
        cmma::store::<F>(
            slice,
            &accumulators.index(n),
            UInt::new(16),
            cmma::MatrixLayout::RowMajor,
        );
    }
}

fn compute_loop_test_case<R: Runtime>(
    block_config: CmmaConfig,
    expected: &[f32],
    device: &R::Device,
) {
    if !cmma_available::<R>(device) {
        // We can't execute the test, skip.
        return;
    }

    let client = R::client(device);
    let lhs = range_tensor_f16::<R>(&client, block_config.b_mn, block_config.b_k);
    let rhs = range_tensor_f16::<R>(&client, block_config.b_k, block_config.b_mn);
    let results = create_empty::<R>(&client, block_config.b_mn, block_config.b_mn);
    let cube_dim = block_config.cube_dim();
    let cube_count = block_config.cube_count::<R>(&[block_config.b_mn, block_config.b_mn]);

    let comptime_info =
        block_config.comptime_info(block_config.b_mn, block_config.b_k, block_config.b_mn);

    unsafe {
        compute_loop_test::launch_unchecked::<F32, F16, R>(
            &R::client(device),
            cube_count,
            cube_dim,
            TensorArg::from_raw_parts(&lhs.handle, &lhs.strides, &lhs.shape, 1),
            TensorArg::from_raw_parts(&rhs.handle, &rhs.strides, &rhs.shape, 1),
            ArrayArg::from_raw_parts(&results, block_config.b_mn * block_config.b_mn, 1),
            UInt::new(block_config.b_mn as u32),
            UInt::new(block_config.b_k as u32),
            comptime_info,
        );
    };

    assert_equals::<R>(&client, results, expected);
}

/// Exported test
pub fn cmma_compute_loop_block_equal_tile_test<R: Runtime>(device: &R::Device) {
    compute_loop_test_case::<R>(
        CmmaConfig::new(16, 16, false, WriteOutStrategy::LargeSmem),
        &[
            19840.0, 19960.0, 20080.0, 20200.0, 20320.0, 20440.0, 20560.0, 20680.0, 20800.0,
            20920.0, 21040.0, 21160.0, 21280.0, 21400.0, 21520.0, 21640.0, 50560.0, 50936.0,
            51312.0, 51688.0, 52064.0, 52440.0, 52816.0, 53192.0, 53568.0, 53944.0, 54320.0,
            54696.0, 55072.0, 55448.0, 55824.0, 56200.0, 81280.0, 81912.0, 82544.0, 83176.0,
            83808.0, 84440.0, 85072.0, 85704.0, 86336.0, 86968.0, 87600.0, 88232.0, 88864.0,
            89496.0, 90128.0, 90760.0, 112000.0, 112888.0, 113776.0, 114664.0, 115552.0, 116440.0,
            117328.0, 118216.0, 119104.0, 119992.0, 120880.0, 121768.0, 122656.0, 123544.0,
            124432.0, 125320.0, 142720.0, 143864.0, 145008.0, 146152.0, 147296.0, 148440.0,
            149584.0, 150728.0, 151872.0, 153016.0, 154160.0, 155304.0, 156448.0, 157592.0,
            158736.0, 159880.0, 173440.0, 174840.0, 176240.0, 177640.0, 179040.0, 180440.0,
            181840.0, 183240.0, 184640.0, 186040.0, 187440.0, 188840.0, 190240.0, 191640.0,
            193040.0, 194440.0, 204160.0, 205816.0, 207472.0, 209128.0, 210784.0, 212440.0,
            214096.0, 215752.0, 217408.0, 219064.0, 220720.0, 222376.0, 224032.0, 225688.0,
            227344.0, 229000.0, 234880.0, 236792.0, 238704.0, 240616.0, 242528.0, 244440.0,
            246352.0, 248264.0, 250176.0, 252088.0, 254000.0, 255912.0, 257824.0, 259736.0,
            261648.0, 263560.0, 265600.0, 267768.0, 269936.0, 272104.0, 274272.0, 276440.0,
            278608.0, 280776.0, 282944.0, 285112.0, 287280.0, 289448.0, 291616.0, 293784.0,
            295952.0, 298120.0, 296320.0, 298744.0, 301168.0, 303592.0, 306016.0, 308440.0,
            310864.0, 313288.0, 315712.0, 318136.0, 320560.0, 322984.0, 325408.0, 327832.0,
            330256.0, 332680.0, 327040.0, 329720.0, 332400.0, 335080.0, 337760.0, 340440.0,
            343120.0, 345800.0, 348480.0, 351160.0, 353840.0, 356520.0, 359200.0, 361880.0,
            364560.0, 367240.0, 357760.0, 360696.0, 363632.0, 366568.0, 369504.0, 372440.0,
            375376.0, 378312.0, 381248.0, 384184.0, 387120.0, 390056.0, 392992.0, 395928.0,
            398864.0, 401800.0, 388480.0, 391672.0, 394864.0, 398056.0, 401248.0, 404440.0,
            407632.0, 410824.0, 414016.0, 417208.0, 420400.0, 423592.0, 426784.0, 429976.0,
            433168.0, 436360.0, 419200.0, 422648.0, 426096.0, 429544.0, 432992.0, 436440.0,
            439888.0, 443336.0, 446784.0, 450232.0, 453680.0, 457128.0, 460576.0, 464024.0,
            467472.0, 470920.0, 449920.0, 453624.0, 457328.0, 461032.0, 464736.0, 468440.0,
            472144.0, 475848.0, 479552.0, 483256.0, 486960.0, 490664.0, 494368.0, 498072.0,
            501776.0, 505480.0, 480640.0, 484600.0, 488560.0, 492520.0, 496480.0, 500440.0,
            504400.0, 508360.0, 512320.0, 516280.0, 520240.0, 524200.0, 528160.0, 532120.0,
            536080.0, 540040.0,
        ],
        device,
    );
}

/// Exported test
pub fn cmma_compute_loop_block_larger_than_tile_test<R: Runtime>(device: &R::Device) {
    compute_loop_test_case::<R>(
        CmmaConfig::new(32, 32, false, WriteOutStrategy::LargeSmem),
        &[
            1610496.0, 1614832.0, 1619168.0, 1623504.0, 1627840.0, 1632176.0, 1636512.0, 1640848.0,
            1645184.0, 1649520.0, 1653856.0, 1658192.0, 1662528.0, 1666864.0, 1671200.0, 1675536.0,
            1737472.0, 1742320.0, 1747168.0, 1752016.0, 1756864.0, 1761712.0, 1766560.0, 1771408.0,
            1776256.0, 1781104.0, 1785952.0, 1790800.0, 1795648.0, 1800496.0, 1805344.0, 1810192.0,
            1864448.0, 1869808.0, 1875168.0, 1880528.0, 1885888.0, 1891248.0, 1896608.0, 1901968.0,
            1907328.0, 1912688.0, 1918048.0, 1923408.0, 1928768.0, 1934128.0, 1939488.0, 1944848.0,
            1991424.0, 1997296.0, 2003168.0, 2009040.0, 2014912.0, 2020784.0, 2026656.0, 2032528.0,
            2038400.0, 2044272.0, 2050144.0, 2056016.0, 2061888.0, 2067760.0, 2073632.0, 2079504.0,
            2118400.0, 2124784.0, 2131168.0, 2137552.0, 2143936.0, 2150320.0, 2156704.0, 2163088.0,
            2169472.0, 2175856.0, 2182240.0, 2188624.0, 2195008.0, 2201392.0, 2207776.0, 2214160.0,
            2245376.0, 2252272.0, 2259168.0, 2266064.0, 2272960.0, 2279856.0, 2286752.0, 2293648.0,
            2300544.0, 2307440.0, 2314336.0, 2321232.0, 2328128.0, 2335024.0, 2341920.0, 2348816.0,
            2372352.0, 2379760.0, 2387168.0, 2394576.0, 2401984.0, 2409392.0, 2416800.0, 2424208.0,
            2431616.0, 2439024.0, 2446432.0, 2453840.0, 2461248.0, 2468656.0, 2476064.0, 2483472.0,
            2499328.0, 2507248.0, 2515168.0, 2523088.0, 2531008.0, 2538928.0, 2546848.0, 2554768.0,
            2562688.0, 2570608.0, 2578528.0, 2586448.0, 2594368.0, 2602288.0, 2610208.0, 2618128.0,
            2626304.0, 2634736.0, 2643168.0, 2651600.0, 2660032.0, 2668464.0, 2676896.0, 2685328.0,
            2693760.0, 2702192.0, 2710624.0, 2719056.0, 2727488.0, 2735920.0, 2744352.0, 2752784.0,
            2753280.0, 2762224.0, 2771168.0, 2780112.0, 2789056.0, 2798000.0, 2806944.0, 2815888.0,
            2824832.0, 2833776.0, 2842720.0, 2851664.0, 2860608.0, 2869552.0, 2878496.0, 2887440.0,
            2880256.0, 2889712.0, 2899168.0, 2908624.0, 2918080.0, 2927536.0, 2936992.0, 2946448.0,
            2955904.0, 2965360.0, 2974816.0, 2984272.0, 2993728.0, 3003184.0, 3012640.0, 3022096.0,
            3007232.0, 3017200.0, 3027168.0, 3037136.0, 3047104.0, 3057072.0, 3067040.0, 3077008.0,
            3086976.0, 3096944.0, 3106912.0, 3116880.0, 3126848.0, 3136816.0, 3146784.0, 3156752.0,
            3134208.0, 3144688.0, 3155168.0, 3165648.0, 3176128.0, 3186608.0, 3197088.0, 3207568.0,
            3218048.0, 3228528.0, 3239008.0, 3249488.0, 3259968.0, 3270448.0, 3280928.0, 3291408.0,
            3261184.0, 3272176.0, 3283168.0, 3294160.0, 3305152.0, 3316144.0, 3327136.0, 3338128.0,
            3349120.0, 3360112.0, 3371104.0, 3382096.0, 3393088.0, 3404080.0, 3415072.0, 3426064.0,
            3388160.0, 3399664.0, 3411168.0, 3422672.0, 3434176.0, 3445680.0, 3457184.0, 3468688.0,
            3480192.0, 3491696.0, 3503200.0, 3514704.0, 3526208.0, 3537712.0, 3549216.0, 3560720.0,
            3515136.0, 3527152.0, 3539168.0, 3551184.0, 3563200.0, 3575216.0, 3587232.0, 3599248.0,
            3611264.0, 3623280.0, 3635296.0, 3647312.0, 3659328.0, 3671344.0, 3683360.0, 3695376.0,
            3830528.0, 3834864.0, 3839200.0, 3843536.0, 3847872.0, 3852208.0, 3856544.0, 3860880.0,
            3865216.0, 3869552.0, 3873888.0, 3878224.0, 3882560.0, 3886896.0, 3891232.0, 3895568.0,
            4219648.0, 4224496.0, 4229344.0, 4234192.0, 4239040.0, 4243888.0, 4248736.0, 4253584.0,
            4258432.0, 4263280.0, 4268128.0, 4272976.0, 4277824.0, 4282672.0, 4287520.0, 4292368.0,
            4608768.0, 4614128.0, 4619488.0, 4624848.0, 4630208.0, 4635568.0, 4640928.0, 4646288.0,
            4651648.0, 4657008.0, 4662368.0, 4667728.0, 4673088.0, 4678448.0, 4683808.0, 4689168.0,
            4997888.0, 5003760.0, 5009632.0, 5015504.0, 5021376.0, 5027248.0, 5033120.0, 5038992.0,
            5044864.0, 5050736.0, 5056608.0, 5062480.0, 5068352.0, 5074224.0, 5080096.0, 5085968.0,
            5387008.0, 5393392.0, 5399776.0, 5406160.0, 5412544.0, 5418928.0, 5425312.0, 5431696.0,
            5438080.0, 5444464.0, 5450848.0, 5457232.0, 5463616.0, 5470000.0, 5476384.0, 5482768.0,
            5776128.0, 5783024.0, 5789920.0, 5796816.0, 5803712.0, 5810608.0, 5817504.0, 5824400.0,
            5831296.0, 5838192.0, 5845088.0, 5851984.0, 5858880.0, 5865776.0, 5872672.0, 5879568.0,
            6165248.0, 6172656.0, 6180064.0, 6187472.0, 6194880.0, 6202288.0, 6209696.0, 6217104.0,
            6224512.0, 6231920.0, 6239328.0, 6246736.0, 6254144.0, 6261552.0, 6268960.0, 6276368.0,
            6554368.0, 6562288.0, 6570208.0, 6578128.0, 6586048.0, 6593968.0, 6601888.0, 6609808.0,
            6617728.0, 6625648.0, 6633568.0, 6641488.0, 6649408.0, 6657328.0, 6665248.0, 6673168.0,
            6943488.0, 6951920.0, 6960352.0, 6968784.0, 6977216.0, 6985648.0, 6994080.0, 7002512.0,
            7010944.0, 7019376.0, 7027808.0, 7036240.0, 7044672.0, 7053104.0, 7061536.0, 7069968.0,
            7332608.0, 7341552.0, 7350496.0, 7359440.0, 7368384.0, 7377328.0, 7386272.0, 7395216.0,
            7404160.0, 7413104.0, 7422048.0, 7430992.0, 7439936.0, 7448880.0, 7457824.0, 7466768.0,
            7721728.0, 7731184.0, 7740640.0, 7750096.0, 7759552.0, 7769008.0, 7778464.0, 7787920.0,
            7797376.0, 7806832.0, 7816288.0, 7825744.0, 7835200.0, 7844656.0, 7854112.0, 7863568.0,
            8110848.0, 8120816.0, 8130784.0, 8140752.0, 8150720.0, 8160688.0, 8170656.0, 8180624.0,
            8190592.0, 8200560.0, 8210528.0, 8220496.0, 8230464.0, 8240432.0, 8250400.0, 8260368.0,
            8499968.0, 8510448.0, 8520928.0, 8531408.0, 8541888.0, 8552368.0, 8562848.0, 8573328.0,
            8583808.0, 8594288.0, 8604768.0, 8615248.0, 8625728.0, 8636208.0, 8646688.0, 8657168.0,
            8889088.0, 8900080.0, 8911072.0, 8922064.0, 8933056.0, 8944048.0, 8955040.0, 8966032.0,
            8977024.0, 8988016.0, 8999008.0, 9010000.0, 9020992.0, 9031984.0, 9042976.0, 9053968.0,
            9278208.0, 9289712.0, 9301216.0, 9312720.0, 9324224.0, 9335728.0, 9347232.0, 9358736.0,
            9370240.0, 9381744.0, 9393248.0, 9404752.0, 9416256.0, 9427760.0, 9439264.0, 9450768.0,
            9667328.0, 9679344.0, 9691360.0, 9703376.0, 9715392.0, 9727408.0, 9739424.0, 9751440.0,
            9763456.0, 9775472.0, 9787488.0, 9799504.0, 9811520.0, 9823536.0, 9835552.0, 9847568.0,
            5673728.0, 5694448.0, 5715168.0, 5735888.0, 5756608.0, 5777328.0, 5798048.0, 5818768.0,
            5839488.0, 5860208.0, 5880928.0, 5901648.0, 5922368.0, 5943088.0, 5963808.0, 5984528.0,
            5800704.0, 5821936.0, 5843168.0, 5864400.0, 5885632.0, 5906864.0, 5928096.0, 5949328.0,
            5970560.0, 5991792.0, 6013024.0, 6034256.0, 6055488.0, 6076720.0, 6097952.0, 6119184.0,
            5927680.0, 5949424.0, 5971168.0, 5992912.0, 6014656.0, 6036400.0, 6058144.0, 6079888.0,
            6101632.0, 6123376.0, 6145120.0, 6166864.0, 6188608.0, 6210352.0, 6232096.0, 6253840.0,
            6054656.0, 6076912.0, 6099168.0, 6121424.0, 6143680.0, 6165936.0, 6188192.0, 6210448.0,
            6232704.0, 6254960.0, 6277216.0, 6299472.0, 6321728.0, 6343984.0, 6366240.0, 6388496.0,
            6181632.0, 6204400.0, 6227168.0, 6249936.0, 6272704.0, 6295472.0, 6318240.0, 6341008.0,
            6363776.0, 6386544.0, 6409312.0, 6432080.0, 6454848.0, 6477616.0, 6500384.0, 6523152.0,
            6308608.0, 6331888.0, 6355168.0, 6378448.0, 6401728.0, 6425008.0, 6448288.0, 6471568.0,
            6494848.0, 6518128.0, 6541408.0, 6564688.0, 6587968.0, 6611248.0, 6634528.0, 6657808.0,
            6435584.0, 6459376.0, 6483168.0, 6506960.0, 6530752.0, 6554544.0, 6578336.0, 6602128.0,
            6625920.0, 6649712.0, 6673504.0, 6697296.0, 6721088.0, 6744880.0, 6768672.0, 6792464.0,
            6562560.0, 6586864.0, 6611168.0, 6635472.0, 6659776.0, 6684080.0, 6708384.0, 6732688.0,
            6756992.0, 6781296.0, 6805600.0, 6829904.0, 6854208.0, 6878512.0, 6902816.0, 6927120.0,
            6689536.0, 6714352.0, 6739168.0, 6763984.0, 6788800.0, 6813616.0, 6838432.0, 6863248.0,
            6888064.0, 6912880.0, 6937696.0, 6962512.0, 6987328.0, 7012144.0, 7036960.0, 7061776.0,
            6816512.0, 6841840.0, 6867168.0, 6892496.0, 6917824.0, 6943152.0, 6968480.0, 6993808.0,
            7019136.0, 7044464.0, 7069792.0, 7095120.0, 7120448.0, 7145776.0, 7171104.0, 7196432.0,
            6943488.0, 6969328.0, 6995168.0, 7021008.0, 7046848.0, 7072688.0, 7098528.0, 7124368.0,
            7150208.0, 7176048.0, 7201888.0, 7227728.0, 7253568.0, 7279408.0, 7305248.0, 7331088.0,
            7070464.0, 7096816.0, 7123168.0, 7149520.0, 7175872.0, 7202224.0, 7228576.0, 7254928.0,
            7281280.0, 7307632.0, 7333984.0, 7360336.0, 7386688.0, 7413040.0, 7439392.0, 7465744.0,
            7197440.0, 7224304.0, 7251168.0, 7278032.0, 7304896.0, 7331760.0, 7358624.0, 7385488.0,
            7412352.0, 7439216.0, 7466080.0, 7492944.0, 7519808.0, 7546672.0, 7573536.0, 7600400.0,
            7324416.0, 7351792.0, 7379168.0, 7406544.0, 7433920.0, 7461296.0, 7488672.0, 7516048.0,
            7543424.0, 7570800.0, 7598176.0, 7625552.0, 7652928.0, 7680304.0, 7707680.0, 7735056.0,
            7451392.0, 7479280.0, 7507168.0, 7535056.0, 7562944.0, 7590832.0, 7618720.0, 7646608.0,
            7674496.0, 7702384.0, 7730272.0, 7758160.0, 7786048.0, 7813936.0, 7841824.0, 7869712.0,
            7578368.0, 7606768.0, 7635168.0, 7663568.0, 7691968.0, 7720368.0, 7748768.0, 7777168.0,
            7805568.0, 7833968.0, 7862368.0, 7890768.0, 7919168.0, 7947568.0, 7975968.0, 8004368.0,
            16282368.0, 16303088.0, 16323808.0, 16344528.0, 16365248.0, 16385968.0, 16406688.0,
            16427408.0, 16448128.0, 16468848.0, 16489568.0, 16510288.0, 16531008.0, 16551728.0,
            16572448.0, 16593168.0, 16671488.0, 16692720.0, 16713952.0, 16735184.0, 16756416.0,
            16777648.0, 16798880.0, 16820112.0, 16841344.0, 16862576.0, 16883808.0, 16905040.0,
            16926272.0, 16947504.0, 16968736.0, 16989968.0, 17060608.0, 17082352.0, 17104096.0,
            17125840.0, 17147584.0, 17169328.0, 17191072.0, 17212816.0, 17234560.0, 17256304.0,
            17278048.0, 17299792.0, 17321536.0, 17343280.0, 17365024.0, 17386768.0, 17449728.0,
            17471984.0, 17494240.0, 17516496.0, 17538752.0, 17561008.0, 17583264.0, 17605520.0,
            17627776.0, 17650032.0, 17672288.0, 17694544.0, 17716800.0, 17739056.0, 17761312.0,
            17783568.0, 17838848.0, 17861616.0, 17884384.0, 17907152.0, 17929920.0, 17952688.0,
            17975456.0, 17998224.0, 18020992.0, 18043760.0, 18066528.0, 18089296.0, 18112064.0,
            18134832.0, 18157600.0, 18180368.0, 18227968.0, 18251248.0, 18274528.0, 18297808.0,
            18321088.0, 18344368.0, 18367648.0, 18390928.0, 18414208.0, 18437488.0, 18460768.0,
            18484048.0, 18507328.0, 18530608.0, 18553888.0, 18577168.0, 18617088.0, 18640880.0,
            18664672.0, 18688464.0, 18712256.0, 18736048.0, 18759840.0, 18783632.0, 18807424.0,
            18831216.0, 18855008.0, 18878800.0, 18902592.0, 18926384.0, 18950176.0, 18973968.0,
            19006208.0, 19030512.0, 19054816.0, 19079120.0, 19103424.0, 19127728.0, 19152032.0,
            19176336.0, 19200640.0, 19224944.0, 19249248.0, 19273552.0, 19297856.0, 19322160.0,
            19346464.0, 19370768.0, 19395328.0, 19420144.0, 19444960.0, 19469776.0, 19494592.0,
            19519408.0, 19544224.0, 19569040.0, 19593856.0, 19618672.0, 19643488.0, 19668304.0,
            19693120.0, 19717936.0, 19742752.0, 19767568.0, 19784448.0, 19809776.0, 19835104.0,
            19860432.0, 19885760.0, 19911088.0, 19936416.0, 19961744.0, 19987072.0, 20012400.0,
            20037728.0, 20063056.0, 20088384.0, 20113712.0, 20139040.0, 20164368.0, 20173568.0,
            20199408.0, 20225248.0, 20251088.0, 20276928.0, 20302768.0, 20328608.0, 20354448.0,
            20380288.0, 20406128.0, 20431968.0, 20457808.0, 20483648.0, 20509488.0, 20535328.0,
            20561168.0, 20562688.0, 20589040.0, 20615392.0, 20641744.0, 20668096.0, 20694448.0,
            20720800.0, 20747152.0, 20773504.0, 20799856.0, 20826208.0, 20852560.0, 20878912.0,
            20905264.0, 20931616.0, 20957968.0, 20951808.0, 20978672.0, 21005536.0, 21032400.0,
            21059264.0, 21086128.0, 21112992.0, 21139856.0, 21166720.0, 21193584.0, 21220448.0,
            21247312.0, 21274176.0, 21301040.0, 21327904.0, 21354768.0, 21340928.0, 21368304.0,
            21395680.0, 21423056.0, 21450432.0, 21477808.0, 21505184.0, 21532560.0, 21559936.0,
            21587312.0, 21614688.0, 21642064.0, 21669440.0, 21696816.0, 21724192.0, 21751568.0,
            21730048.0, 21757936.0, 21785824.0, 21813712.0, 21841600.0, 21869488.0, 21897376.0,
            21925264.0, 21953152.0, 21981040.0, 22008928.0, 22036816.0, 22064704.0, 22092592.0,
            22120480.0, 22148368.0, 22119168.0, 22147568.0, 22175968.0, 22204368.0, 22232768.0,
            22261168.0, 22289568.0, 22317968.0, 22346368.0, 22374768.0, 22403168.0, 22431568.0,
            22459968.0, 22488368.0, 22516768.0, 22545168.0,
        ],
        device,
    );
}

/// Exported test
pub fn cmma_compute_loop_b_mn_larger_than_b_k_test<R: Runtime>(device: &R::Device) {
    compute_loop_test_case::<R>(
        CmmaConfig::new(32, 16, false, WriteOutStrategy::LargeSmem),
        &[
            19840.0, 19960.0, 20080.0, 20200.0, 20320.0, 20440.0, 20560.0, 20680.0, 20800.0,
            20920.0, 21040.0, 21160.0, 21280.0, 21400.0, 21520.0, 21640.0, 50560.0, 50936.0,
            51312.0, 51688.0, 52064.0, 52440.0, 52816.0, 53192.0, 53568.0, 53944.0, 54320.0,
            54696.0, 55072.0, 55448.0, 55824.0, 56200.0, 81280.0, 81912.0, 82544.0, 83176.0,
            83808.0, 84440.0, 85072.0, 85704.0, 86336.0, 86968.0, 87600.0, 88232.0, 88864.0,
            89496.0, 90128.0, 90760.0, 112000.0, 112888.0, 113776.0, 114664.0, 115552.0, 116440.0,
            117328.0, 118216.0, 119104.0, 119992.0, 120880.0, 121768.0, 122656.0, 123544.0,
            124432.0, 125320.0, 142720.0, 143864.0, 145008.0, 146152.0, 147296.0, 148440.0,
            149584.0, 150728.0, 151872.0, 153016.0, 154160.0, 155304.0, 156448.0, 157592.0,
            158736.0, 159880.0, 173440.0, 174840.0, 176240.0, 177640.0, 179040.0, 180440.0,
            181840.0, 183240.0, 184640.0, 186040.0, 187440.0, 188840.0, 190240.0, 191640.0,
            193040.0, 194440.0, 204160.0, 205816.0, 207472.0, 209128.0, 210784.0, 212440.0,
            214096.0, 215752.0, 217408.0, 219064.0, 220720.0, 222376.0, 224032.0, 225688.0,
            227344.0, 229000.0, 234880.0, 236792.0, 238704.0, 240616.0, 242528.0, 244440.0,
            246352.0, 248264.0, 250176.0, 252088.0, 254000.0, 255912.0, 257824.0, 259736.0,
            261648.0, 263560.0, 265600.0, 267768.0, 269936.0, 272104.0, 274272.0, 276440.0,
            278608.0, 280776.0, 282944.0, 285112.0, 287280.0, 289448.0, 291616.0, 293784.0,
            295952.0, 298120.0, 296320.0, 298744.0, 301168.0, 303592.0, 306016.0, 308440.0,
            310864.0, 313288.0, 315712.0, 318136.0, 320560.0, 322984.0, 325408.0, 327832.0,
            330256.0, 332680.0, 327040.0, 329720.0, 332400.0, 335080.0, 337760.0, 340440.0,
            343120.0, 345800.0, 348480.0, 351160.0, 353840.0, 356520.0, 359200.0, 361880.0,
            364560.0, 367240.0, 357760.0, 360696.0, 363632.0, 366568.0, 369504.0, 372440.0,
            375376.0, 378312.0, 381248.0, 384184.0, 387120.0, 390056.0, 392992.0, 395928.0,
            398864.0, 401800.0, 388480.0, 391672.0, 394864.0, 398056.0, 401248.0, 404440.0,
            407632.0, 410824.0, 414016.0, 417208.0, 420400.0, 423592.0, 426784.0, 429976.0,
            433168.0, 436360.0, 419200.0, 422648.0, 426096.0, 429544.0, 432992.0, 436440.0,
            439888.0, 443336.0, 446784.0, 450232.0, 453680.0, 457128.0, 460576.0, 464024.0,
            467472.0, 470920.0, 449920.0, 453624.0, 457328.0, 461032.0, 464736.0, 468440.0,
            472144.0, 475848.0, 479552.0, 483256.0, 486960.0, 490664.0, 494368.0, 498072.0,
            501776.0, 505480.0, 480640.0, 484600.0, 488560.0, 492520.0, 496480.0, 500440.0,
            504400.0, 508360.0, 512320.0, 516280.0, 520240.0, 524200.0, 528160.0, 532120.0,
            536080.0, 540040.0, 50560.0, 50680.0, 50800.0, 50920.0, 51040.0, 51160.0, 51280.0,
            51400.0, 51520.0, 51640.0, 51760.0, 51880.0, 52000.0, 52120.0, 52240.0, 52360.0,
            146816.0, 147192.0, 147568.0, 147944.0, 148320.0, 148696.0, 149072.0, 149448.0,
            149824.0, 150200.0, 150576.0, 150952.0, 151328.0, 151704.0, 152080.0, 152456.0,
            243072.0, 243704.0, 244336.0, 244968.0, 245600.0, 246232.0, 246864.0, 247496.0,
            248128.0, 248760.0, 249392.0, 250024.0, 250656.0, 251288.0, 251920.0, 252552.0,
            339328.0, 340216.0, 341104.0, 341992.0, 342880.0, 343768.0, 344656.0, 345544.0,
            346432.0, 347320.0, 348208.0, 349096.0, 349984.0, 350872.0, 351760.0, 352648.0,
            435584.0, 436728.0, 437872.0, 439016.0, 440160.0, 441304.0, 442448.0, 443592.0,
            444736.0, 445880.0, 447024.0, 448168.0, 449312.0, 450456.0, 451600.0, 452744.0,
            531840.0, 533240.0, 534640.0, 536040.0, 537440.0, 538840.0, 540240.0, 541640.0,
            543040.0, 544440.0, 545840.0, 547240.0, 548640.0, 550040.0, 551440.0, 552840.0,
            628096.0, 629752.0, 631408.0, 633064.0, 634720.0, 636376.0, 638032.0, 639688.0,
            641344.0, 643000.0, 644656.0, 646312.0, 647968.0, 649624.0, 651280.0, 652936.0,
            724352.0, 726264.0, 728176.0, 730088.0, 732000.0, 733912.0, 735824.0, 737736.0,
            739648.0, 741560.0, 743472.0, 745384.0, 747296.0, 749208.0, 751120.0, 753032.0,
            820608.0, 822776.0, 824944.0, 827112.0, 829280.0, 831448.0, 833616.0, 835784.0,
            837952.0, 840120.0, 842288.0, 844456.0, 846624.0, 848792.0, 850960.0, 853128.0,
            916864.0, 919288.0, 921712.0, 924136.0, 926560.0, 928984.0, 931408.0, 933832.0,
            936256.0, 938680.0, 941104.0, 943528.0, 945952.0, 948376.0, 950800.0, 953224.0,
            1013120.0, 1015800.0, 1018480.0, 1021160.0, 1023840.0, 1026520.0, 1029200.0, 1031880.0,
            1034560.0, 1037240.0, 1039920.0, 1042600.0, 1045280.0, 1047960.0, 1050640.0, 1053320.0,
            1109376.0, 1112312.0, 1115248.0, 1118184.0, 1121120.0, 1124056.0, 1126992.0, 1129928.0,
            1132864.0, 1135800.0, 1138736.0, 1141672.0, 1144608.0, 1147544.0, 1150480.0, 1153416.0,
            1205632.0, 1208824.0, 1212016.0, 1215208.0, 1218400.0, 1221592.0, 1224784.0, 1227976.0,
            1231168.0, 1234360.0, 1237552.0, 1240744.0, 1243936.0, 1247128.0, 1250320.0, 1253512.0,
            1301888.0, 1305336.0, 1308784.0, 1312232.0, 1315680.0, 1319128.0, 1322576.0, 1326024.0,
            1329472.0, 1332920.0, 1336368.0, 1339816.0, 1343264.0, 1346712.0, 1350160.0, 1353608.0,
            1398144.0, 1401848.0, 1405552.0, 1409256.0, 1412960.0, 1416664.0, 1420368.0, 1424072.0,
            1427776.0, 1431480.0, 1435184.0, 1438888.0, 1442592.0, 1446296.0, 1450000.0, 1453704.0,
            1494400.0, 1498360.0, 1502320.0, 1506280.0, 1510240.0, 1514200.0, 1518160.0, 1522120.0,
            1526080.0, 1530040.0, 1534000.0, 1537960.0, 1541920.0, 1545880.0, 1549840.0, 1553800.0,
            511360.0, 515576.0, 519792.0, 524008.0, 528224.0, 532440.0, 536656.0, 540872.0,
            545088.0, 549304.0, 553520.0, 557736.0, 561952.0, 566168.0, 570384.0, 574600.0,
            542080.0, 546552.0, 551024.0, 555496.0, 559968.0, 564440.0, 568912.0, 573384.0,
            577856.0, 582328.0, 586800.0, 591272.0, 595744.0, 600216.0, 604688.0, 609160.0,
            572800.0, 577528.0, 582256.0, 586984.0, 591712.0, 596440.0, 601168.0, 605896.0,
            610624.0, 615352.0, 620080.0, 624808.0, 629536.0, 634264.0, 638992.0, 643720.0,
            603520.0, 608504.0, 613488.0, 618472.0, 623456.0, 628440.0, 633424.0, 638408.0,
            643392.0, 648376.0, 653360.0, 658344.0, 663328.0, 668312.0, 673296.0, 678280.0,
            634240.0, 639480.0, 644720.0, 649960.0, 655200.0, 660440.0, 665680.0, 670920.0,
            676160.0, 681400.0, 686640.0, 691880.0, 697120.0, 702360.0, 707600.0, 712840.0,
            664960.0, 670456.0, 675952.0, 681448.0, 686944.0, 692440.0, 697936.0, 703432.0,
            708928.0, 714424.0, 719920.0, 725416.0, 730912.0, 736408.0, 741904.0, 747400.0,
            695680.0, 701432.0, 707184.0, 712936.0, 718688.0, 724440.0, 730192.0, 735944.0,
            741696.0, 747448.0, 753200.0, 758952.0, 764704.0, 770456.0, 776208.0, 781960.0,
            726400.0, 732408.0, 738416.0, 744424.0, 750432.0, 756440.0, 762448.0, 768456.0,
            774464.0, 780472.0, 786480.0, 792488.0, 798496.0, 804504.0, 810512.0, 816520.0,
            757120.0, 763384.0, 769648.0, 775912.0, 782176.0, 788440.0, 794704.0, 800968.0,
            807232.0, 813496.0, 819760.0, 826024.0, 832288.0, 838552.0, 844816.0, 851080.0,
            787840.0, 794360.0, 800880.0, 807400.0, 813920.0, 820440.0, 826960.0, 833480.0,
            840000.0, 846520.0, 853040.0, 859560.0, 866080.0, 872600.0, 879120.0, 885640.0,
            818560.0, 825336.0, 832112.0, 838888.0, 845664.0, 852440.0, 859216.0, 865992.0,
            872768.0, 879544.0, 886320.0, 893096.0, 899872.0, 906648.0, 913424.0, 920200.0,
            849280.0, 856312.0, 863344.0, 870376.0, 877408.0, 884440.0, 891472.0, 898504.0,
            905536.0, 912568.0, 919600.0, 926632.0, 933664.0, 940696.0, 947728.0, 954760.0,
            880000.0, 887288.0, 894576.0, 901864.0, 909152.0, 916440.0, 923728.0, 931016.0,
            938304.0, 945592.0, 952880.0, 960168.0, 967456.0, 974744.0, 982032.0, 989320.0,
            910720.0, 918264.0, 925808.0, 933352.0, 940896.0, 948440.0, 955984.0, 963528.0,
            971072.0, 978616.0, 986160.0, 993704.0, 1001248.0, 1008792.0, 1016336.0, 1023880.0,
            941440.0, 949240.0, 957040.0, 964840.0, 972640.0, 980440.0, 988240.0, 996040.0,
            1003840.0, 1011640.0, 1019440.0, 1027240.0, 1035040.0, 1042840.0, 1050640.0, 1058440.0,
            972160.0, 980216.0, 988272.0, 996328.0, 1004384.0, 1012440.0, 1020496.0, 1028552.0,
            1036608.0, 1044664.0, 1052720.0, 1060776.0, 1068832.0, 1076888.0, 1084944.0, 1093000.0,
            1590656.0, 1594872.0, 1599088.0, 1603304.0, 1607520.0, 1611736.0, 1615952.0, 1620168.0,
            1624384.0, 1628600.0, 1632816.0, 1637032.0, 1641248.0, 1645464.0, 1649680.0, 1653896.0,
            1686912.0, 1691384.0, 1695856.0, 1700328.0, 1704800.0, 1709272.0, 1713744.0, 1718216.0,
            1722688.0, 1727160.0, 1731632.0, 1736104.0, 1740576.0, 1745048.0, 1749520.0, 1753992.0,
            1783168.0, 1787896.0, 1792624.0, 1797352.0, 1802080.0, 1806808.0, 1811536.0, 1816264.0,
            1820992.0, 1825720.0, 1830448.0, 1835176.0, 1839904.0, 1844632.0, 1849360.0, 1854088.0,
            1879424.0, 1884408.0, 1889392.0, 1894376.0, 1899360.0, 1904344.0, 1909328.0, 1914312.0,
            1919296.0, 1924280.0, 1929264.0, 1934248.0, 1939232.0, 1944216.0, 1949200.0, 1954184.0,
            1975680.0, 1980920.0, 1986160.0, 1991400.0, 1996640.0, 2001880.0, 2007120.0, 2012360.0,
            2017600.0, 2022840.0, 2028080.0, 2033320.0, 2038560.0, 2043800.0, 2049040.0, 2054280.0,
            2071936.0, 2077432.0, 2082928.0, 2088424.0, 2093920.0, 2099416.0, 2104912.0, 2110408.0,
            2115904.0, 2121400.0, 2126896.0, 2132392.0, 2137888.0, 2143384.0, 2148880.0, 2154376.0,
            2168192.0, 2173944.0, 2179696.0, 2185448.0, 2191200.0, 2196952.0, 2202704.0, 2208456.0,
            2214208.0, 2219960.0, 2225712.0, 2231464.0, 2237216.0, 2242968.0, 2248720.0, 2254472.0,
            2264448.0, 2270456.0, 2276464.0, 2282472.0, 2288480.0, 2294488.0, 2300496.0, 2306504.0,
            2312512.0, 2318520.0, 2324528.0, 2330536.0, 2336544.0, 2342552.0, 2348560.0, 2354568.0,
            2360704.0, 2366968.0, 2373232.0, 2379496.0, 2385760.0, 2392024.0, 2398288.0, 2404552.0,
            2410816.0, 2417080.0, 2423344.0, 2429608.0, 2435872.0, 2442136.0, 2448400.0, 2454664.0,
            2456960.0, 2463480.0, 2470000.0, 2476520.0, 2483040.0, 2489560.0, 2496080.0, 2502600.0,
            2509120.0, 2515640.0, 2522160.0, 2528680.0, 2535200.0, 2541720.0, 2548240.0, 2554760.0,
            2553216.0, 2559992.0, 2566768.0, 2573544.0, 2580320.0, 2587096.0, 2593872.0, 2600648.0,
            2607424.0, 2614200.0, 2620976.0, 2627752.0, 2634528.0, 2641304.0, 2648080.0, 2654856.0,
            2649472.0, 2656504.0, 2663536.0, 2670568.0, 2677600.0, 2684632.0, 2691664.0, 2698696.0,
            2705728.0, 2712760.0, 2719792.0, 2726824.0, 2733856.0, 2740888.0, 2747920.0, 2754952.0,
            2745728.0, 2753016.0, 2760304.0, 2767592.0, 2774880.0, 2782168.0, 2789456.0, 2796744.0,
            2804032.0, 2811320.0, 2818608.0, 2825896.0, 2833184.0, 2840472.0, 2847760.0, 2855048.0,
            2841984.0, 2849528.0, 2857072.0, 2864616.0, 2872160.0, 2879704.0, 2887248.0, 2894792.0,
            2902336.0, 2909880.0, 2917424.0, 2924968.0, 2932512.0, 2940056.0, 2947600.0, 2955144.0,
            2938240.0, 2946040.0, 2953840.0, 2961640.0, 2969440.0, 2977240.0, 2985040.0, 2992840.0,
            3000640.0, 3008440.0, 3016240.0, 3024040.0, 3031840.0, 3039640.0, 3047440.0, 3055240.0,
            3034496.0, 3042552.0, 3050608.0, 3058664.0, 3066720.0, 3074776.0, 3082832.0, 3090888.0,
            3098944.0, 3107000.0, 3115056.0, 3123112.0, 3131168.0, 3139224.0, 3147280.0, 3155336.0,
        ],
        device,
    );
}
